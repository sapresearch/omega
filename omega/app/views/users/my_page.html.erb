<% require_stylesheet 'omega_volunteering', 'settings', 'omega_users_table', 'omega_users' %>
<%= require_javascript 'omega_users' %>

<script type="text/javascript">
	$(document).ready(function() {
		div_height();
		$('#skills div.draggable').draggable({containment: 'table#skills', snap: '.droppable_skills', snapMode: 'inner' });
		$('#interests div.draggable').draggable({containment: 'table#interests', snap: '.droppable_interests', snapMode: 'inner' });
		// Droppables to add tags.
		$("#droppable_skills").droppable({
			drop: function(event, ui) {
				if("other" == ui.draggable.attr('id')) {
					add_tag($( this ), ui.draggable, "#contact_skill_ids");
				}
			}
		});
		$("#droppable_interests").droppable({
			drop: function(event, ui) {
				if("other" == ui.draggable.attr('id')) {
					add_tag($( this ), ui.draggable, "#contact_interest_ids");
				}
			}
		});

		// Droppables to remove tags.
		$("#other_skills").droppable({
			drop: function(event, ui) {
				if("own" == ui.draggable.attr('id')) {
					remove_tag($( this ), ui.draggable, "#contact_skill_ids");
				}
			}
		});
		$("#other_interests").droppable({
			drop: function(event, ui) {
				if("own" == ui.draggable.attr('id')) {
					remove_tag($( this ), ui.draggable, "#contact_interest_ids");
				}
			}
		});
	});

	add_tag = function(self, dragged, input_id){
		var tag_id = dragged.attr('ui-data');
		var old_val = $(input_id).attr( 'value' ).replace(']', '');
		$(input_id).val(old_val + ", " + tag_id + "]");
		div_height();
		switch_css(dragged);
	}

	remove_tag = function(self, dragged, input_id){
		var tag_id = dragged.attr('ui-data');
		var old_val = $(input_id).attr( 'value' ).replace(']', '').replace('[', '').replace(' ', '').split(',');
		var index = -1;
		for(i=0; i < old_val.length; i++){
			var needle = RegExp(tag_id);
			var haystack = old_val[i].replace(" ", "");
			if(needle.test(haystack)){
				index = i;
			}
		}
		if(index != -1){ old_val.splice(index,1); }
		$(input_id).val(old_val.join(', '));

		var val = $(input_id).val;
		switch_css(dragged);
	}
		
	switch_css = function(dragged){
		if(dragged.attr( 'id' ) == "own"){
			dragged.css('background-color', 'blue');
			dragged.css('color', 'white');
			dragged.attr( 'id', 'other');
		}
		else{
			dragged.css('background-color', 'lightBlue');
			dragged.css('color', 'black');
			dragged.attr( 'id', 'own');
		}
	}
	
	div_height = function(){
		var skills = $('#contact_skill_ids').attr( 'value' ).split(',').length;
		var interests = $('#contact_interest_ids').attr( 'value' ).split(',').length;
		var longer = skills > interests ? skills : interests;
		var height = 36 * Math.ceil(longer / 3);
		$('#droppable_interests').css('height', height);
		$('#droppable_skills').css('height', height);
	}


</script>



<html xmlns="http://www.w3.org/1999/xhtml" xmlns:fb="http://www.facebook.com/2008/fbml">

<body>

	<div id="fb">
	  <div id="fb-root"></div>
	  <script src="http://connect.facebook.net/en_US/all.js"></script>
	  <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
     <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
     <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>
	  <script>
	    FB.init({ appId: '117866098303408', cookie:true, status:true, xfbml:true });
			function fb_message(){
				user_message = " ";
				FB.ui({ method: 'feed', message: user_message});
			}
	  </script>



<div class="content circle-corners-bottom-left">

<div class="heading-main">
	<h1 class="page-content">
		<% if current_user.nil? then %>
			<%= current_user.first_name + "'s" %>
			<%= current_user.username + "'s" if current_user.first_name.blank? %>
		<% end %>
		MyOmega Page
	</h1>
</div>



<h3 class="content-heading"> My Volunteering Events</h3>
	<table class="accounts">
		<tbody>
			<% @positions.each do |element| %>
				<% position = element[:position] %>
				<tr class="accounts" >
         			<td class="accounts"> <%= link_to(position.name, volunteering_position_path(position)) %></td>
         			<td class="accounts"> <%= link_to(position.start_date, volunteering_position_path(position)) %></td>
         			<td class="accounts"> Status: <i><%= element[:record] %></i></td>
         			<td class="accounts"> 
							<form onsubmit="fb_message()">
								<input type="submit" id="fb" size="0" maxlength="0" value="facebook" /> 
							</form>
						</td>
         			<td class="accounts"> 
							<% full = url_for(:only_path => false).to_s %>
							<% unneccessary = url_for().to_s %>
							<% host = full.gsub(unneccessary, "") %>
							<% position_url = host + (url_for(volunteering_position_path(position))).to_s %>
							
							<div id="twitter">
								<a href="https://twitter.com/share" class="twitter-share-button" data-url="<%=position_url%>" data-text="Check this out" data-count="none">Tweet</a>
								<script type="text/javascript" src="//platform.twitter.com/widgets.js"></script>
							</div>
						</td>
					</tr>
				<% end %>
			</tbody>
		</table>

	<!-- Unneccessary, since we don't need offline access anymore. !-->
		<!--<fb:login-button perms="offline_access">Login with Facebook</fb:login-button>!-->
	<!-- Unneccessary, since we don't need offline access anymore. !-->


	<br /><br />

		<div id="skills_and_interests">
			<%= render 'skills_and_interests' %>
		</div>

	</div>
</body>
